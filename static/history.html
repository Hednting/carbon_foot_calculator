<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å†å²è®°å½• - ç¢³è¶³è¿¹è®¡ç®—å™¨</title>
    <link rel="stylesheet" href="./css/base.css">
    <link rel="stylesheet" href="./css/index.css">
    <script src="https://cdn.jsdelivr.net/npm/echarts@5.4.3/dist/echarts.min.js"></script>
</head>
<body>
    <!-- å¤´éƒ¨åŒºåŸŸ -->
    <div class="header">
        <div class="wrapper">
            <div class="logo">
                <h1><a href="#">ç¢³è¶³è¿¹</a></h1>
            </div>
            <div class="nav">
                <ul>
                    <li><a href="./index.html">é¦–é¡µ</a></li>
                    <li><a href="./calculator.html">ç¢³è¶³è¿¹è®¡ç®—</a></li>
                    <li><a href="./knowledge.html">çŸ¥è¯†å°é—®ç­”</a></li>
                    <li><a href="./history.html" class="active">å†å²è®°å½•</a></li>
                </ul>
            </div>
            <button id="loginBtn" class="login-btn">ç™»å½•</button>
        </div>
    </div>
    <div class="wrapper" style="margin-top:40px;">
        <h2 style="text-align:center;margin-bottom:24px;">å†å²ç¢³è¶³è¿¹è®°å½•</h2>
        <div id="historyTableContainer" style="background:#fff;border-radius:12px;padding:24px 18px;box-shadow:0 2px 12px rgba(0,0,0,0.07);margin-bottom:32px;">
            <table id="historyTable" style="width:100%;border-collapse:collapse;text-align:center;">
                <thead>
                    <tr style="background:#f3f5f7;">
                        <th>æ—¥æœŸ</th>
                        <th>é£Ÿ</th>
                        <th>è¡Œ</th>
                        <th>ç”¨</th>
                        <th>æ€»è®¡ (kgCOâ‚‚e)</th>
                    </tr>
                </thead>
                <tbody>
                    <!-- è®°å½•æ•°æ®ç”±JSå¡«å…… -->
                </tbody>
            </table>
        </div>
        <div id="historyChart" style="width:100%;max-width:800px;height:400px;margin:0 auto 40px auto;"></div>
        <div class="encourage-box">
          <span class="encourage-icon">ğŸŒŸ</span>
          <span class="encourage-text">æ¯ä¸€æ¬¡è®°å½•ï¼Œéƒ½æ˜¯å®ˆæŠ¤åœ°çƒçš„è¡ŒåŠ¨ï¼åšæŒä½ç¢³ç”Ÿæ´»ï¼Œä½ å°±æ˜¯ç»¿è‰²æ¦œæ ·ï¼</span>
        </div>
    </div>
    <script src="./script.js"></script>
    <script src="./login.js"></script>
    <script>
    // å†å²è®°å½•å±•ç¤ºä¸å¯è§†åŒ– - åªä½¿ç”¨åç«¯æ•°æ®
    function renderHistoryFromServer() {
        const username = localStorage.getItem('currentUser');
        if (!username) {
            console.log('ç”¨æˆ·æœªç™»å½•');
            return;
        }
        
        fetch('/api/history?username=' + encodeURIComponent(username))
            .then(res => res.json())
            .then(data => {
                if (data.success && Array.isArray(data.history)) {
                    renderHistoryTable(data.history);
                } else {
                    console.log('è·å–å†å²è®°å½•å¤±è´¥:', data.msg);
                    renderHistoryTable([]);
                }
            })
            .catch(error => {
                console.error('è¯·æ±‚å†å²è®°å½•å‡ºé”™:', error);
                renderHistoryTable([]);
            });
    }

    function renderHistoryTable(history) {
        const tableBody = document.querySelector('#historyTable tbody');
        const chartDom = document.getElementById('historyChart');
        
        tableBody.innerHTML = '';
        let foodArr = [], travelArr = [], utilityArr = [], totalArr = [], dateArr = [];
        
        history.forEach(item => {
            tableBody.innerHTML += `<tr><td>${item.date}</td><td>${item.food}</td><td>${item.travel}</td><td>${item.utility}</td><td>${item.total}</td></tr>`;
            dateArr.push(item.date);
            foodArr.push(item.food);
            travelArr.push(item.travel);
            utilityArr.push(item.utility);
            totalArr.push(item.total);
        });
        
        // EChartså¯è§†åŒ–
        if (chartDom && window.echarts) {
            const myChart = echarts.init(chartDom);
            const option = {
                title: { text: 'ç¢³è¶³è¿¹å†å²è¶‹åŠ¿', left: 'center' },
                tooltip: { trigger: 'axis' },
                legend: { data: ['é£Ÿ', 'è¡Œ', 'ç”¨', 'æ€»è®¡'], top: 30 },
                xAxis: { type: 'category', data: dateArr },
                yAxis: { type: 'value', name: 'kgCOâ‚‚e' },
                series: [
                    { name: 'é£Ÿ', type: 'line', data: foodArr },
                    { name: 'è¡Œ', type: 'line', data: travelArr },
                    { name: 'ç”¨', type: 'line', data: utilityArr },
                    { name: 'æ€»è®¡', type: 'line', data: totalArr, lineStyle: { width: 3 } }
                ]
            };
            myChart.setOption(option);
        }
    }

    // é¡µé¢åŠ è½½æ—¶ä»åç«¯è·å–å†å²è®°å½•
    document.addEventListener('DOMContentLoaded', function() {
        const loginBtn = document.getElementById('loginBtn');
        const currentUser = localStorage.getItem('currentUser');
        if (loginBtn && currentUser) {
            loginBtn.innerText = 'æ¬¢è¿ï¼Œ' + currentUser;
            loginBtn.disabled = true;
            loginBtn.style.background = '#0a5833';
            loginBtn.style.cursor = 'default';
        }
        
        // ä»åç«¯åŠ è½½å†å²è®°å½•
        renderHistoryFromServer();
    });
    </script>
</body>
</html> 